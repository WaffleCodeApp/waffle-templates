{
 "Conditions": {
  "ALLOW_ADMIN_CREATE_USER_ONLY": {
   "Fn::Equals": [
    {
     "Ref": "AllowAdminCreateUserOnly"
    },
    "True"
   ]
  }
 },
 "Outputs": {
  "AuthIdentityPoolRef": {
   "Description": "AuthIdentityPoolRef",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthIdentityPoolRef"
      ]
     ]
    }
   },
   "Value": {
    "Ref": "AuthIdentityPool"
   }
  },
  "AuthRoleArn": {
   "Description": "The ARN of the authorized role for users",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthRoleArn"
      ]
     ]
    }
   },
   "Value": {
    "Fn::GetAtt": [
     "AuthRole",
     "Arn"
    ]
   }
  },
  "AuthRoleId": {
   "Description": "The ID of the authorized role for users",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthRoleId"
      ]
     ]
    }
   },
   "Value": {
    "Fn::GetAtt": [
     "AuthRole",
     "RoleId"
    ]
   }
  },
  "AuthRoleName": {
   "Description": "The name of the authorized role for admin",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthRoleName"
      ]
     ]
    }
   },
   "Value": {
    "Ref": "AuthRole"
   }
  },
  "AuthUserPoolArn": {
   "Description": "AuthUserPoolArn",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthUserPoolArn"
      ]
     ]
    }
   },
   "Value": {
    "Fn::GetAtt": [
     "MFAUserPool",
     "Arn"
    ]
   }
  },
  "AuthUserPoolClientWebRef": {
   "Description": "AuthUserPoolClientWebRef",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthUserPoolClientWebRef"
      ]
     ]
    }
   },
   "Value": {
    "Ref": "UserPoolClientWeb"
   }
  },
  "AuthUserPoolRef": {
   "Description": "AuthUserPoolRef",
   "Export": {
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-AuthUserPoolRef"
      ]
     ]
    }
   },
   "Value": {
    "Ref": "MFAUserPool"
   }
  }
 },
 "Parameters": {
  "AllowAdminCreateUserOnly": {
   "AllowedValues": [
    "True",
    "False"
   ],
   "Default": "True",
   "Description": "Only admin can create new users?",
   "Type": "String"
  },
  "DeploymentId": {
   "Description": "deployment_id",
   "Type": "String"
  }
 },
 "Resources": {
  "AuthIdentityPool": {
   "Properties": {
    "AllowUnauthenticatedIdentities": false,
    "CognitoIdentityProviders": [
     {
      "ClientId": {
       "Ref": "UserPoolClientWeb"
      },
      "ProviderName": {
       "Fn::GetAtt": [
        "MFAUserPool",
        "ProviderName"
       ]
      }
     }
    ],
    "DeveloperProviderName": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-users"
      ]
     ]
    }
   },
   "Type": "AWS::Cognito::IdentityPool"
  },
  "AuthIdentityPoolRoleMap": {
   "DependsOn": "AuthIdentityPool",
   "Properties": {
    "IdentityPoolId": {
     "Ref": "AuthIdentityPool"
    },
    "Roles": {
     "authenticated": {
      "Fn::GetAtt": [
       "AuthRole",
       "Arn"
      ]
     }
    }
   },
   "Type": "AWS::Cognito::IdentityPoolRoleAttachment"
  },
  "AuthRole": {
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": [
        "sts:AssumeRoleWithWebIdentity"
       ],
       "Condition": {
        "ForAnyValue:StringLike": {
         "cognito-identity.amazonaws.com:amr": "authenticated"
        },
        "StringEquals": {
         "cognito-identity.amazonaws.com:aud": {
          "Ref": "AuthIdentityPool"
         }
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Federated": [
         "cognito-identity.amazonaws.com"
        ]
       }
      }
     ]
    },
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "execute-api:Invoke"
         ],
         "Effect": "Allow",
         "Resource": [
          {
           "Fn::Join": [
            "",
            [
             "arn:aws:execute-api:",
             {
              "Ref": "AWS::Region"
             },
             ":",
             {
              "Ref": "AWS::AccountId"
             },
             ":",
             "*",
             "/*"
            ]
           ]
          }
         ]
        },
        {
         "Action": [
          "cognito-sync:*",
          "cognito-identity:*"
         ],
         "Effect": "Allow",
         "Resource": "*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": {
       "Fn::Join": [
        "",
        [
         {
          "Ref": "DeploymentId"
         },
         "-user-mfa-auth-policy"
        ]
       ]
      }
     }
    ],
    "RoleName": {
     "Fn::Join": [
      "",
      [
       "Waffle-",
       {
        "Ref": "DeploymentId"
       },
       "-authentication-userpool-AuthRole"
      ]
     ]
    }
   },
   "Type": "AWS::IAM::Role"
  },
  "AuthSnsRole": {
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": [
        "sts:AssumeRole"
       ],
       "Effect": "Allow",
       "Principal": {
        "Service": [
         "cognito-idp.amazonaws.com"
        ]
       }
      }
     ]
    },
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "sns:Publish"
         ],
         "Effect": "Allow",
         "Resource": "*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": {
       "Fn::Join": [
        "",
        [
         {
          "Ref": "DeploymentId"
         },
         "-AuthMFASnsPolicy"
        ]
       ]
      }
     }
    ],
    "RoleName": {
     "Fn::Join": [
      "",
      [
       "Waffle-",
       {
        "Ref": "DeploymentId"
       },
       "-authentication-userpool-SnsRole"
      ]
     ]
    }
   },
   "Type": "AWS::IAM::Role"
  },
  "AuthUserPoolRole": {
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": [
        "sts:AssumeRole"
       ],
       "Effect": "Allow",
       "Principal": {
        "Service": [
         "lambda.amazonaws.com"
        ]
       }
      }
     ]
    },
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "lambda:CreateFunction",
          "sns:Publish",
          "s3:GetObject"
         ],
         "Effect": "Allow",
         "Resource": "*"
        },
        {
         "Action": [
          "logs:*"
         ],
         "Effect": "Allow",
         "Resource": "arn:aws:logs:*:*:*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": {
       "Fn::Join": [
        "",
        [
         {
          "Ref": "DeploymentId"
         },
         "-AuthMFAUserPoolPolicy"
        ]
       ]
      }
     }
    ],
    "RoleName": {
     "Fn::Join": [
      "",
      [
       "Waffle-",
       {
        "Ref": "DeploymentId"
       },
       "-authentication-userpool-LambdaRole"
      ]
     ]
    }
   },
   "Type": "AWS::IAM::Role"
  },
  "MFAUserPool": {
   "Properties": {
    "AdminCreateUserConfig": {
     "AllowAdminCreateUserOnly": {
      "Fn::If": [
       "ALLOW_ADMIN_CREATE_USER_ONLY",
       true,
       false
      ]
     }
    },
    "EnabledMfas": [
     "SOFTWARE_TOKEN_MFA"
    ],
    "MfaConfiguration": "ON",
    "Policies": {
     "PasswordPolicy": {
      "MinimumLength": 12,
      "RequireLowercase": true,
      "RequireNumbers": true,
      "RequireSymbols": true,
      "RequireUppercase": true
     }
    },
    "Schema": [
     {
      "Mutable": true,
      "Name": "email",
      "Required": true
     },
     {
      "AttributeDataType": "String",
      "Mutable": true,
      "Name": "role",
      "Required": false
     },
     {
      "AttributeDataType": "String",
      "Mutable": true,
      "Name": "organization",
      "Required": false
     }
    ],
    "UserPoolName": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-users"
      ]
     ]
    },
    "UsernameAttributes": [
     "email"
    ]
   },
   "Type": "AWS::Cognito::UserPool"
  },
  "UserPoolClientWeb": {
   "DependsOn": "MFAUserPool",
   "Properties": {
    "ClientName": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "DeploymentId"
       },
       "-web"
      ]
     ]
    },
    "GenerateSecret": false,
    "ReadAttributes": [
     "email",
     "email_verified",
     "name",
     "picture",
     "custom:role",
     "custom:organization"
    ],
    "UserPoolId": {
     "Ref": "MFAUserPool"
    },
    "WriteAttributes": [
     "email",
     "name",
     "picture"
    ]
   },
   "Type": "AWS::Cognito::UserPoolClient"
  }
 }
}